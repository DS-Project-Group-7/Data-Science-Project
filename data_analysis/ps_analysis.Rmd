---
title: "Painting Support Analysis"
date: '2022-09-18'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
art <- read.csv("../data/cleanData.csv")
art <- art %>%
  filter(!is.na(auxiliary_support_condition)) %>%
  filter(!is.na(media_condition)) %>%
  filter(!is.na(ground_condition)) %>%
  filter(!is.na(painting_support_condition)) %>%
  filter(!is.na(frame_condition)) %>%
  mutate(auxiliary_support_condition = recode(auxiliary_support_condition, "0" = "Poor", "1" = "Fair", "2" = "Good", "3" = "Excellent")) %>%
  mutate(media_condition = recode(media_condition, "0" = "Poor", "1" = "Fair", "2" = "Good", "3" = "Excellent")) %>%
  mutate(ground_condition = recode(ground_condition, "0" = "Poor", "1" = "Fair", "2" = "Good", "3" = "Excellent")) %>%
  mutate(painting_support_condition = recode(painting_support_condition, "0" = "Poor", "1" = "Fair", "2" = "Good", "3" = "Excellent")) %>%
  mutate(frame_condition = recode(frame_condition, "0" = "Poor", "1" = "Fair", "2" = "Good", "3" = "Excellent"))
```

```{r}
target_col <- c("collection", "auxiliary_support_condition", "media_condition", 
                "ground_condition", "painting_support_condition", "frame_condition")
conditions <- art[, target_col]
```

# Test independence between museum collection and auxiliary support condition
```{r}
aux_contingency <- table(conditions$collection, 
                         factor(conditions$auxiliary_support_condition, 
                                levels = c("Poor", "Fair", "Good")))
(test1 <- chisq.test(aux_contingency))
test1$expected
```
Here, we would like to test if there's an association between the museum collection and the condition of the auxiliary support. As we can see from the Pearson's chi-squared test from above, the $\chi^2$ statistics is 8.344, which is greater than the critical value $\chi^2_{0.95}(6)$ as the p-value 0.214 indicates, hence there is no association between the museum collection and the auxiliary support condition. However, one of the major problem here is that, given the sample size are small, the test statistics might not be approximated well by the $\chi^2$ distribution, as we can see there are one cell with expected counts less than 5. Therefore, a Fisher's exact test might be more appropriate.

```{r}
(test2 <- fisher.test(aux_contingency))
```
As we can see, the p-value returned by the Fisher's exact test is 0.2434, which is greater than the significance level of 0.05. Thus, there are no association between the two.

# Test independence between museum collection and painting support condition
```{r}
(ps_contingency <- table(conditions$collection, factor(conditions$painting_support_condition, 
                                                       levels = c("Poor", "Fair", "Good", "Excellent"))))
 
(test1 <- chisq.test(ps_contingency))
test1$expected
```
In the second test, we would like to test if there's an association between the museum collection and the painting support condition. As we can see from the deviance table above, the $\chi^2$ statistics is 4.870, which is less than the critical value $\chi^2_{0.95}(8)$ as the p-value is greater than the significant level of 0.05. Therefore, we do not reject the null hypothesis, and there's no association between museum collection and the painting support condition. However, we do notice there are several cells with expected count lower than 5. Thus, we will perform Fisher's exact test again.

```{r}
(test2 <- fisher.test(ps_contingency, workspace = 2e8))
```
As we can see that the returned p-value 0.5031 is greater than the significance level of 0.05, thus, the two variables are independent.

# Test independence between museum collection and paint layer condition
```{r}
(pl_condition <- table(conditions$collection, factor(conditions$media_condition, 
                       levels = c("Poor", "Fair", "Good", "Excellent"))))
(test1 <- chisq.test(pl_condition))
test1$expected
```
In the third test, we tested if there's an association between the museum collection and the paint layer condition. As we can see from the deviance table above, the $\chi^2$ statistics is 15.309, which is smaller than the critical value $\chi^2_{0.95}(7)$ as the p-value is greater than the significance level of 0.05. In this case, we would reject the null hypothesis, thus, there's an association between the two factors. Although, we did rejected the null hypothesis, we still could not trust the result, given that there are quite a few cells in the contingency tables with expected count less than 5, therefore the $\chi^2$ approximation may not be good enough and the Chi-square test is not appropriate, and in this case the Fisher's exact test is preferred.

```{r}
(test2 <- fisher.test(pl_condition, workspace = 2e8))
```
As we can see, the returned p-value is 0.005789, thus, we reject the null hypothesis, and there's an association between the museum collection and the paint layer condition.

```{r}
library(ggplot2)
library(ggstatsplot)
library(ggmosaic)
```

```{r echo = FALSE,fig.width = 4, fig.height = 1.5}
pl_mosaic <- conditions %>%
  count(collection, media_condition)
pl_mosaic$media_condition <- factor(pl_mosaic$media_condition, levels = c("Poor", "Fair", "Good", "Excellent"))

ggplot(pl_mosaic) +
  geom_mosaic(aes(weight = n, x = product(media_condition), fill = collection)) +
  ggtitle("Paint Layer Condition Mosaic Plot") +
  theme(axis.text.y = element_blank(), legend.key.size = unit(0.4, 'cm'),
        legend.text = element_text(size=7)) +
  xlab("Paint Layer Condition") + 
  ylab("Museum Collection") +
  guides(fill=guide_legend(title="Museum Collection", reverse = TRUE))
```
Here, we used an effective visualisation technique for contingency table, mosaic plot. The idea of the mosaic plot is to represent each cell of the contingency table by a box, where the area of each box equals to the count of the cell. As the plot depicted, paintings with an excellent paint layer condition has an greater probability being from the heritage conservation board of Singapore, while paintings with good condition has less probability being from the National Gallery of Thailand.

# Testing independence between museum collection and frame condition
```{r}
(fr_condition <- table(conditions$collection, factor(conditions$frame_condition, 
                       levels = c("Poor", "Fair", "Good", "Excellent"))))
(test1 <- chisq.test(fr_condition))
test1$expected
```

```{r}
(test2 <- fisher.test(fr_condition, workspace = 2e8))
```

```{r echo = FALSE,fig.width = 4, fig.height = 1.5}
fr_mosaic <- conditions %>%
  count(collection, frame_condition)
fr_mosaic$media_condition <- factor(fr_mosaic$frame_condition, levels = c("Poor", "Fair", "Good", "Excellent"))

ggplot(fr_mosaic) +
  geom_mosaic(aes(weight = n, x = product(frame_condition), fill = collection)) +
  ggtitle("Frame Condition Mosaic Plot") +
  theme(axis.text.y = element_blank(), legend.key.size = unit(0.4, 'cm'),
        legend.text = element_text(size=7)) +
  xlab("Frame Condition") + 
  ylab("Museum Collection") +
  guides(fill=guide_legend(title="Museum Collection", reverse = TRUE))
```
With the mosaic plot above, we can see that 


# Testing independence of other binary attributes
```{r}
paint_support_condition <- c(
  'collection',
  'painting_support_condition',
  'planar_painting_support',
  'warped_painting_support',
  'indentations_painting_support',
  'good_tension_painting_support',
  'holes_painting_support',
  'loose_painting_support',
  'tears_painting_support',
  'taut_painting_support',
  'surface_dirt_painting_support',
  'mould_painting_support',
  'staining_painting_support',
  'corner_distortions_painting_support',
  'top_distortions_painting_support',
  'bottom_distortions_painting_support',
  'overall_distortions_painting_support',
  'insect_damage_painting_support',
  'rust_stains_on_support_painting_support',
  'deformation_around_tacks_staples_painting_support',
  'tears_around_tacks_staples_painting_support',
  'loss_of_tacks_insecure_support_painting_support'
)

paint_support_df <- art[paint_support_condition]

colnames(paint_support_df) <- c('collection', 'condition ratings', 'planar', 'warped', 'indentations', 'good tension', 
                                'holes', 'loose', 'tears', 'taut', 'surface dirt', 
                                'mould', 'staining', 'corner distortions',
                                'top distortions', 'bottom distortions', 'overall distortions',
                                'insect damage', 'rust stains', 'deformation around tack staples',
                                'tears around tack staples', 'loss of tack insecure support')
paint_support_df <- paint_support_df %>% mutate_if(is.integer, as.factor)
```

```{r warning=T}
attr1 <- c()
attr2 <- c()
pval <- c()
count <- 1
for (i in 2:22) {
  for (j in 2:22) {
    if (i == j) {
    } else {
      attr1[count] <- colnames(paint_support_df)[i]
      attr2[count] <- colnames(paint_support_df)[j]
      test_df <- as.data.frame(ftable(paint_support_df$collection, paint_support_df[,j],
                                     paint_support_df[,i]))
      test_df$wt <- ifelse(test_df$Freq == 0, 0, 1)
      three_way <- glm(Freq ~ factor(Var3)*factor(Var1) + factor(Var2)*factor(Var1), 
                       family = poisson, data = test_df, weights = wt)
      pval[count] <- tail(anova(three_way, test = "Chi")$`Pr(>Chi)`, 1)
      #pval[count] <- fisher.test(table(paint_support_df[,i], paint_support_df[,j]))$p.value
      count <- count + 1
    }
  }
}

temp <- as.data.frame(cbind(attr1, attr2, pval))
temp$pval <- as.double(temp$pval)
temp$independent <- ifelse(temp$pval > 0.05, "Independent", "Not Independent")
temp$independent <- as.factor(temp$independent)
temp <- temp[, c("attr1", "attr2", "independent")]
```

```{r}
ggplot(temp, aes(x = attr1, y = attr2, fill = independent)) +
  ggtitle("Painting Support Independence Testing Results") +
  geom_tile(color = "white") + xlab("Attributes") + ylab("Attributes") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  scale_fill_manual(values = c("#B6B0FF", "green"))
```
Given paintings were sourced from four different museums, thus we would like to test the condition independence of each condition attributes given the four levels of museum. To do this, we've fitted the log-linear model for each pairwise variables, and perform $\chi^2$ test to determine whether the are likely to be related or not given different museum. The fitted model is given below, where $\mathtt{M}$, $\mathtt{C1}$, and $\mathtt{C2}$ is the museum, first condition attribute, second condition attribute, respectively.
$$log(\lambda_{ijk}) = \mu + \mathtt{M_i} + \mathtt{C1_j} + \mathtt{C2_k} + (\mathtt{M}\cdot\mathtt{C1})_{ij} + (\mathtt{M}\cdot\mathtt{C2})_{ik}$$
However, the first problem we immediately encounter is the zero cells from the constructed contingency tables. Zero cell in contingency table can be distinguished as two types, sampling zeros and structural zeros, where the former is due to sampling variability, while the latter are cells known to have zero values. Thus, in our case the zeros can be treated as structural zeros, given the cell values are simply missing because it has no paintings in that category. Therefore, we will test quasi-independence, where zero cells will be excluded from analysis when testing independence. The second problem we encountered is some contingency tables were over crowded with zero cells. Therefore, the model fitted was saturated where the residual deviance and degrees of freedom was reduced to zeros, and the model overfits the data, and the test is not reliable.

Therefore, instead of testing the independence of two condition attributes given different museums, we simply test the independence between two condition attributes using fisher's exact test.
